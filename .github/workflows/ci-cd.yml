name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  # pull_request:
  #   branches: [ main ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install dependencies
        run: |
          echo "::group::ðŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–"
          pnpm install
          echo "âœ“ ä¾èµ–å®‰è£…å®Œæˆ"
          echo "::endgroup::"

      - name: Generate Prisma Client
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm prisma generate

      - name: Format & Lint code
        run: |
          echo "::group::ðŸ“ æ ¼å¼åŒ–ä»£ç "
          pnpm format
          echo "âœ“ æ ¼å¼åŒ–å®Œæˆ"
          echo "::endgroup::"
          echo "::group::âœ… è´¨é‡æ£€æŸ¥"
          pnpm lint:fix
          echo "âœ“ è´¨é‡æ£€æŸ¥å®Œæˆ"
          echo "::endgroup::"

      - name: Run tests with coverage
        run: |
          echo "::group::ðŸ§ª è¿è¡Œæµ‹è¯•"
          pnpm test --ci --coverage
          echo "âœ“ æµ‹è¯•å®Œæˆ"
          echo "::endgroup::"

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Jest Test Results
          path: coverage/test-results.json
          reporter: jest-junit

      # - name: Build
      #   run: |
      #     echo "::group::ðŸ—ï¸ æž„å»ºé¡¹ç›®"
      #     pnpm build
      #     echo "âœ“ æž„å»ºå®Œæˆ"
      #     echo "::endgroup::"

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
  build-and-publish:
    needs: lint-and-test  # ä»…åœ¨ lint-and-test æˆåŠŸåŽè¿è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            fovrgt/nest-demo:latest
            fovrgt/nest-demo:${{ github.ref_name }}-${{ github.sha }}
            fovrgt/nest-demo:${{ github.run_number }}
          # æž„å»ºæ—¶ä¼ å…¥çŽ¯å¢ƒå˜é‡
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
      - name: Generate Summary
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ CI/CD Pipeline Summary

          ### âœ… æž„å»ºä¿¡æ¯
          - **ä»“åº“**: ${{ github.repository }}
          - **åˆ†æ”¯**: ${{ github.ref_name }}
          - **æäº¤**: ${{ github.sha }}
          - **è¿è¡Œå·**: ${{ github.run_number }}

          ### ðŸ“¦ Docker é•œåƒ
          - fovrgt/nest-demo:latest
          - fovrgt/nest-demo:${{ github.ref_name }}-${{ github.sha }}
          - fovrgt/nest-demo:${{ github.run_number }}

          ### â° æ—¶é—´æˆ³
          - å®Œæˆæ—¶é—´: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          EOF
